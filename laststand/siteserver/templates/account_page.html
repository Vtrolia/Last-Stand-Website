{% extends 'header.html' %}
{% load static %}
{% block title %}<title>Your Account</title>{% endblock %}
{% block head %}
    <link rel= "stylesheet" type="text/css" href="{% static 'styles/style.css' %}">
    <script>const token = "{{ csrf_token }}"</script>
    <script>const reveal = "{% static 'source_images/reveal.png' %}"</script>
    <script>const hide = "{% static 'source_images/hide.png' %}"</script>
    <script>
        window.onload = () => {
            var request = new XMLHttpRequest();
            request.open("POST", "/api/get-user-cloud-info");
            request.setRequestHeader("X-CSRFToken", token);
            request.onload = () => {
                let response = JSON.parse(request.responseText);
                
                let bold = document.createElement("strong");
                bold.textContent = response['status'];
                let status = document.getElementById("account-status");
                status.textContent = "You are a subscriber of the "
                status.appendChild(bold);
                status.innerHTML += " plan"
                
                let cloudCount = document.getElementById("clouds");
                cloudCount.textContent = "clouds owned: ";
                let count = document.createElement("strong");
                count.textContent = response['clouds_owned'];
                cloudCount.appendChild(count);
                
                let cloudList = document.getElementById("cloud-options");
                for (let i = 0; i < response['clouds'].length; i++) {
                    let cloud = document.createElement("li")
                    cloud.textContent = response['clouds'][i];
                    cloud.className = "cloud-option";
                    cloud.setAttribute("data-name", cloud.textContent)
                    cloud.setAttribute("onclick", "displayCloudOptions(this)")
                    cloudList.appendChild(cloud);
                }
            }
            request.send();
            getBaseSettings();
        }
        
        function displayCloudOptions(cloud) {
            var request = new XMLHttpRequest();
            request.open("GET", "/cloud-options-page");
            request.onload = () => {
                let display = document.getElementById("settings-display");
                display.innerHTML = request.responseText;
                document.getElementById("settings-title").textContent = "Settings for " + cloud.getAttribute("data-name");
            }
            request.send(cloud.getAttribute("data-name"));
        }
        
        function getBaseSettings() {
            var request = new XMLHttpRequest();
            request.open("GET", "base-options-page");
            request.onload = () => {
                document.getElementById("settings-display").innerHTML = request.responseText;
            }
            request.send();
            
            var addOnJS = document.querySelectorAll(".addOn");
            for (let i = 0; i < addOnJS.length; i++) {
                addOnJS.item(i).parentElement.removeChild(addOnJS.item(i));
            }
            
        }
        
        function planChange() {
            var request = new XMLHttpRequest();
            request.open("GET", "change-plan-page");
            request.onload = () => {
                document.getElementById("settings-display").innerHTML = request.responseText;
                document.getElementById("settings-title").textContent = "Change your plan";
            }
            request.send();
        }
        
        function passwordReset() {
            var request = new XMLHttpRequest();
            request.open("GET", "password-reset-page");
            request.onload = () => {
                document.getElementById("settings-display").innerHTML = request.responseText;
            }
            request.send();
            
            if (!document.getElementById("passjs")) {
                var passjs = document.createElement("script");
                passjs.setAttribute("class", 'addOn');
                passjs.setAttribute("id", "passjs");
                passjs.setAttribute("src", "{% static 'scripts/password.js' %}");
                document.querySelector("head").append(passjs);
            }
        }
        
        function deleteAccount() {
            var request = new XMLHttpRequest();
            request.open("GET", "delete-account");
            request.onload = () => {
                document.getElementById("settings-display").innerHTML = request.responseText;
            }
            request.send();
            
            if (!document.getElementById("deletejs")) {
                var deletejs = document.createElement("script");
                deletejs.setAttribute("id", "deletejs");
                deletejs.setAttribute("class", 'addOn');
                deletejs.setAttribute("src", "{% static 'scripts/delete.js' %}");
                document.querySelector("head").append(deletejs);
            }
        }
        
        function becomePublisher() {
            var request = new XMLHttpRequest();
            request.open("GET", "become-publisher");
            request.onload = () => {
                document.getElementById("settings-display").innerHTML = request.responseText;
            }
            request.send();
            
            if (!document.getElementById("becomejs")) {
                var becomejs = document.createElement("script");
                becomejs.setAttribute("id", "becomejs");
                becomejs.className = "addOn";
                becomejs.setAttribute("src", "{% static 'scripts/become.js' %}");
                document.querySelector("head").append(becomejs);
            }
        }
        
        function changeDetails() {
            var request = new XMLHttpRequest();
            request.open("GET", "change-details");
            request.onload = () => {
                document.getElementById("settings-display").innerHTML = request.responseText;
            }
            request.send();
        }
        
        
    </script>
{% endblock %}
{% block body %}
    <div id="account-page" class="jumbotron">
        <div id="account-details">
            <div id="account-picture">
                {% if account_picture %}
                <img src="{{ account_picture }}" width=128>
                {% else %}
                <img src="{% static 'source_images/user.png' %}" width=128>
                {% endif %}
            </div>
            <div id="identification">
                <strong>{{ message.username }}</strong>
                You joined on <strong>{{ message.date_joined }}</strong>
            </div>
            <div id="account-status"></div>
            <div id="clouds"></div>
            <div id="cloud-list">
                <ul id="cloud-options">
                </ul>
            </div>
        </div>
        <div id="settings-display"></div>
        <div id="settings-bottom">
        <hr style="margin-bottom: 0;">
        <span  style=" position: relative; left: 30%; bottom: 5%;background-color: transparent; outline: none; cursor: pointer" onclick="getBaseSettings()"><img id="backButton" src="{% static 'source_images/back.png' %}" width=48></span>
        </div>
    </div>
{% endblock %}